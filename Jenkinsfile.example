pipeline {
    agent any
    
    environment {
        // Jenkins에서 환경변수 설정 (Jenkins UI > Configure > Build Environment에서도 설정 가능)
        SERVICE_URL = 'https://api.example.com'
        NEXT_PUBLIC_SERVICE_URL = 'https://api.example.com'
        DOCKER_IMAGE_NAME = 'frontend'
        DOCKER_IMAGE_TAG = "${env.BUILD_NUMBER}"
    }
    
    stages {
        stage('Build Docker Image') {
            steps {
                script {
                    // Docker 빌드 시 --build-arg로 환경변수 전달
                    // 이 환경변수들은 빌드 타임에 Next.js 빌드에 사용됨
                    sh """
                        docker build \
                            --build-arg SERVICE_URL=${SERVICE_URL} \
                            --build-arg NEXT_PUBLIC_SERVICE_URL=${NEXT_PUBLIC_SERVICE_URL} \
                            -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \
                            -t ${DOCKER_IMAGE_NAME}:latest \
                            .
                    """
                }
            }
        }
        
        stage('Run Container') {
            steps {
                script {
                    // 컨테이너 실행 시 런타임 환경변수도 전달 가능 (필요시)
                    sh """
                        docker run -d \
                            -p 3000:3000 \
                            --name frontend-${DOCKER_IMAGE_TAG} \
                            ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
                    """
                }
            }
        }
    }
}

